<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amigo Secreto Flex√≠vel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#DC2626',
                        'secondary': '#FBBF24',
                        'background-dark': '#1F2937',
                        'card-light': '#F9FAFB',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* Fundo claro para contraste */
        }
        .container {
            max-width: 900px;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .draw-result {
            background: linear-gradient(135deg, #DC2626 0%, #FBBF24 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-primary mb-6 text-center">Amigo Secreto Flex√≠vel</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Coluna de Cadastro -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl card h-fit">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">1. Seu Cadastro e Acompanhantes</h2>
                <p id="userIdDisplay" class="text-xs text-gray-500 mb-4 break-words"></p>

                <form id="participantForm" onsubmit="event.preventDefault(); saveParticipant();">
                    <div class="mb-4">
                        <label for="participantName" class="block text-sm font-medium text-gray-700 mb-1">Seu Nome (Participante Principal do Sorteio)</label>
                        <input type="text" id="participantName" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150"
                            placeholder="Ex: Ana Silva">
                    </div>

                    <!-- Se√ß√£o de Acompanhantes -->
                    <div class="mb-6 border p-4 rounded-lg bg-card-light">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex justify-between items-center">
                            2. Acompanhantes (Apenas RSVP - N√£o Entram no Sorteio)
                        </h3>
                        <p class="text-sm text-gray-600 mb-3">Liste aqui os nomes dos seus convidados (c√¥njuge, filhos) para a contagem total de presen√ßas.</p>
                        
                        <div id="guestInputsContainer" class="space-y-3">
                            <!-- Inputs de acompanhantes ser√£o adicionados aqui -->
                        </div>

                        <button type="button" onclick="addGuestInput()" class="mt-4 w-full bg-secondary hover:bg-yellow-600 text-white font-medium py-2 rounded-lg transition duration-150 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Adicionar Acompanhante
                        </button>
                    </div>
                    
                    <button type="submit" id="saveButton"
                        class="w-full bg-primary hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-150 disabled:bg-gray-400">
                        Salvar Minha Presen√ßa e Acompanhantes
                    </button>
                    <p id="saveMessage" class="text-sm text-green-600 mt-2 hidden text-center">Cadastro salvo com sucesso!</p>
                </form>
            </div>

            <!-- Coluna de Participantes e Sorteio -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Lista de Participantes -->
                <div class="bg-white p-6 rounded-xl card">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Lista de Presen√ßas</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        <span class="font-bold text-primary" id="totalParticipantsCount">0</span> Participantes no Sorteio /
                        <span class="font-bold text-primary" id="totalAttendeesCount">0</span> Total de Presen√ßas (RSVP)
                    </p>
                    
                    <ul id="participantsList" class="space-y-3">
                        <li class="text-gray-500 italic">Nenhum participante cadastrado.</li>
                    </ul>
                </div>

                <!-- Sorteio -->
                <div class="bg-white p-6 rounded-xl card">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">3. Realizar Sorteio</h2>
                    <p class="text-sm text-gray-600 mb-4">O sorteio s√≥ deve ser feito uma √∫nica vez por um organizador quando todos estiverem cadastrados.</p>
                    <button onclick="confirmAndPerformDraw()" id="drawButton"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-150 disabled:bg-gray-400"
                        disabled>
                        Sortear Amigo Secreto
                    </button>
                    
                    <div id="drawResultContainer" class="mt-6 hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-3">Resultado do Sorteio:</h3>
                        <p id="resultDisplay" class="draw-result"></p>
                    </div>
                </div>

            </div>
        </div>

        <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Confirma√ß√£o Necess√°ria</h3>
                <p id="alertMessage" class="text-gray-600 mb-6">Tem certeza que deseja realizar o sorteio?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeAlert()" class="px-4 py-2 text-gray-600 border rounded-lg hover:bg-gray-100 transition">Cancelar</button>
                    <button onclick="performDraw(true)" id="alertConfirmButton" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-red-700 transition">Confirmar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level to debug for development purposes (optional)
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        window.db = db; // Expose for functions

        const PARTICIPANTS_COLLECTION = 'participants';
        const DRAW_COLLECTION = 'draw_status';

        // --- Firebase Initialization and Auth ---
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authentication Setup
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Authenticated User ID:", userId);
                    document.getElementById('userIdDisplay').textContent = `Seu ID de Participante: ${userId}`;
                    
                    // Proceed to load data and set up listeners
                    if (db) {
                        loadInitialData();
                        setupRealtimeListeners();
                    }
                } else {
                    // Sign in anonymously if no token is available
                    try {
                         if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication error:", error);
                    }
                }
            });
        } else {
            console.error("Firebase config is missing.");
        }

        // --- Firestore References ---

        // Path for public data (participants, draw status) shared among all users of this app
        const getPublicCollectionRef = (collectionName) => {
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        };

        const getParticipantDocRef = (uid) => {
            if (!db) return null;
            return doc(getPublicCollectionRef(PARTICIPANTS_COLLECTION), uid);
        };

        const getDrawStatusDocRef = () => {
             if (!db) return null;
            return doc(getPublicCollectionRef(DRAW_COLLECTION), 'current_draw');
        };

        // --- Data Loading and Listeners ---

        function setupRealtimeListeners() {
            if (!db || !isAuthReady) return;

            // Listener for all participants
            onSnapshot(getPublicCollectionRef(PARTICIPANTS_COLLECTION), (snapshot) => {
                const participants = [];
                snapshot.forEach(doc => {
                    participants.push(doc.data());
                });
                displayParticipants(participants);
                updateDrawButtonState(participants);
            });

            // Listener for draw status (to display the result if the draw has happened)
            onSnapshot(getDrawStatusDocRef(), (docSnapshot) => {
                const drawStatus = docSnapshot.data();
                displayDrawResult(drawStatus);
            });
        }

        async function loadInitialData() {
            if (!userId || !db || !isAuthReady) return;
            // Load current user's data for editing
            try {
                const docRef = getParticipantDocRef(userId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('participantName').value = data.nome || '';
                    
                    // Load Acompanhantes
                    const guestInputsContainer = document.getElementById('guestInputsContainer');
                    guestInputsContainer.innerHTML = ''; // Clear previous inputs
                    
                    if (Array.isArray(data.acompanhantes)) {
                        data.acompanhantes.forEach(guestName => {
                            addGuestInput(guestName);
                        });
                    }
                }
            } catch (error) {
                console.error("Error loading initial data:", error);
            }
        }
        
        // --- UI Functions ---

        window.addGuestInput = (guestName = '') => {
            const container = document.getElementById('guestInputsContainer');
            const guestIndex = container.children.length;

            const div = document.createElement('div');
            div.className = 'flex space-x-2 items-center';
            div.innerHTML = `
                <input type="text" 
                    name="guest-${guestIndex}" 
                    value="${guestName}" 
                    placeholder="Nome do Acompanhante ${guestIndex + 1}"
                    class="flex-grow px-3 py-1 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150 text-sm">
                <button type="button" 
                        onclick="removeGuestInput(this)" 
                        class="text-red-500 hover:text-red-700 p-1 rounded-full transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            container.appendChild(div);
        };

        window.removeGuestInput = (button) => {
            button.closest('div').remove();
        };

        function displayParticipants(participants) {
            const list = document.getElementById('participantsList');
            const totalParticipantsCountEl = document.getElementById('totalParticipantsCount');
            const totalAttendeesCountEl = document.getElementById('totalAttendeesCount');
            list.innerHTML = '';

            let totalAttendees = 0;

            if (participants.length === 0) {
                list.innerHTML = '<li class="text-gray-500 italic">Nenhum participante cadastrado.</li>';
                totalParticipantsCountEl.textContent = 0;
                totalAttendeesCountEl.textContent = 0;
                return;
            }

            participants.forEach(p => {
                const li = document.createElement('li');
                const mainParticipantName = p.nome || `Participante ${p.uid.substring(0, 4)}`;
                const guests = Array.isArray(p.acompanhantes) ? p.acompanhantes.filter(n => n.trim() !== '') : [];
                const guestCount = guests.length;
                
                totalAttendees += 1; // Count primary participant
                totalAttendees += guestCount; // Count guests

                let detailText = '';
                if (guestCount > 0) {
                    detailText = ` (+ ${guestCount} Acompanhante${guestCount > 1 ? 's' : ''}: ${guests.join(', ')})`;
                    li.className = 'p-3 bg-red-50 border-l-4 border-primary rounded-lg';
                } else {
                     li.className = 'p-3 bg-gray-50 border-l-4 border-gray-300 rounded-lg';
                }

                li.innerHTML = `<span class="font-medium text-gray-800">${mainParticipantName}</span> <span class="text-sm text-gray-600">${detailText}</span>`;
                list.appendChild(li);
            });

            totalParticipantsCountEl.textContent = participants.length;
            totalAttendeesCountEl.textContent = totalAttendees;
        }
        
        function updateDrawButtonState(participants) {
             const drawButton = document.getElementById('drawButton');
             // The draw can only happen if there are at least 2 participants (the primary ones)
             drawButton.disabled = participants.length < 2; 
             drawButton.textContent = participants.length < 2 
                ? `M√≠nimo 2 Participantes (Atual: ${participants.length})` 
                : 'Sortear Amigo Secreto';
        }

        function displayDrawResult(drawStatus) {
            const resultContainer = document.getElementById('drawResultContainer');
            const resultDisplay = document.getElementById('resultDisplay');
            
            // Check if the draw was performed
            if (drawStatus && drawStatus.isDrawn && userId) {
                // Find the result specific to the current user
                const result = drawStatus.results.find(r => r.giverId === userId);

                if (result) {
                    // Display the result
                    resultContainer.classList.remove('hidden');
                    resultDisplay.innerHTML = `ü•≥ <span class="font-extrabold text-xl">Voc√™ tirou: ${result.receiverName}</span> üéâ`;
                } else {
                    // Should not happen if the user is in the draw
                    resultContainer.classList.add('hidden');
                }
            } else {
                 resultContainer.classList.add('hidden');
            }
        }


        // --- Firestore Write Functions ---

        window.saveParticipant = async () => {
            if (!userId || !db || !isAuthReady) return;

            const nameInput = document.getElementById('participantName');
            const name = nameInput.value.trim();
            
            if (name === '') {
                nameInput.focus();
                return;
            }

            // Collect guest names
            const guestInputsContainer = document.getElementById('guestInputsContainer');
            const guestInputs = guestInputsContainer.querySelectorAll('input[type="text"]');
            const acompanhantes = Array.from(guestInputs)
                .map(input => input.value.trim())
                .filter(guestName => guestName !== ''); // Filter out empty guest names

            const participantData = {
                uid: userId,
                nome: name,
                acompanhantes: acompanhantes, // Array of guest names
                timestamp: Date.now()
            };

            try {
                await setDoc(getParticipantDocRef(userId), participantData);
                console.log("Participant saved with ID:", userId);
                
                const message = document.getElementById('saveMessage');
                message.textContent = "Cadastro salvo com sucesso!";
                message.classList.remove('hidden');
                setTimeout(() => message.classList.add('hidden'), 3000);

            } catch (e) {
                console.error("Error adding/updating document: ", e);
                const message = document.getElementById('saveMessage');
                message.textContent = "Erro ao salvar o cadastro.";
                message.classList.remove('hidden');
                message.classList.add('text-red-600');
            }
        };


        window.confirmAndPerformDraw = () => {
            document.getElementById('alertModal').classList.remove('hidden');
            document.getElementById('alertMessage').textContent = "Tem certeza que deseja realizar o sorteio? Esta a√ß√£o n√£o pode ser desfeita e exibir√° os resultados para todos os participantes.";
            document.getElementById('alertConfirmButton').onclick = () => performDraw(true);
        };

        window.closeAlert = () => {
            document.getElementById('alertModal').classList.add('hidden');
        };

        // This function MUST be called by the confirm button inside the modal
        window.performDraw = async (isConfirmed) => {
            closeAlert(); // Close the modal immediately

            if (!isConfirmed || !db || !isAuthReady) {
                return;
            }

            const drawDocRef = getDrawStatusDocRef();
            const participantsCollectionRef = getPublicCollectionRef(PARTICIPANTS_COLLECTION);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const drawSnap = await transaction.get(drawDocRef);
                    if (drawSnap.exists() && drawSnap.data().isDrawn) {
                        // Draw already performed, prevent re-execution
                        console.log("Draw already performed. Aborting transaction.");
                        return;
                    }

                    // 1. Get ALL primary participants eligible for the draw
                    const participantsSnap = await getDocs(participantsCollectionRef);
                    let participants = [];
                    participantsSnap.forEach(doc => {
                        const data = doc.data();
                        // Only include participants who have a name (prevent partial entries)
                        if (data.nome && data.nome.trim() !== '') {
                            participants.push({ uid: doc.id, nome: data.nome });
                        }
                    });

                    if (participants.length < 2) {
                        throw new Error("M√≠nimo de 2 participantes √© necess√°rio para o sorteio.");
                    }

                    // 2. Perform the Secret Santa logic
                    const givers = [...participants];
                    let receivers = [...participants];
                    let drawResults = [];
                    let attempts = 0;
                    const maxAttempts = 100;

                    // Fisher-Yates shuffle algorithm
                    function shuffle(array) {
                        for (let i = array.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [array[i], array[j]] = [array[j], array[i]];
                        }
                    }

                    // Perform the draw until a valid non-self-gifting assignment is found
                    let successfulDraw = false;
                    
                    while (!successfulDraw && attempts < maxAttempts) {
                        attempts++;
                        shuffle(receivers); // Shuffle the potential receivers
                        drawResults = [];
                        successfulDraw = true;

                        for (let i = 0; i < givers.length; i++) {
                            const giver = givers[i];
                            const receiver = receivers[i];

                            // Check the main rule: A person cannot draw themselves
                            if (giver.uid === receiver.uid) {
                                successfulDraw = false;
                                break; // Restart the loop if self-draw occurs
                            }
                            
                            // Check the secondary rule: Ensure no cycles of length 2 (A->B, B->A)
                            // This check is complex and often skipped for simplicity, but a simple shuffle is usually sufficient 
                            // to avoid most issues in small groups. The main check is the self-draw.

                            drawResults.push({
                                giverId: giver.uid,
                                giverName: giver.nome,
                                receiverId: receiver.uid,
                                receiverName: receiver.nome
                            });
                        }
                    }
                    
                    if (!successfulDraw) {
                         throw new Error("N√£o foi poss√≠vel realizar um sorteio v√°lido ap√≥s v√°rias tentativas. Tente novamente.");
                    }

                    // 3. Save the results to Firestore
                    const drawData = {
                        isDrawn: true,
                        timestamp: Date.now(),
                        results: drawResults
                    };

                    transaction.set(drawDocRef, drawData);
                    
                    console.log("Sorteio conclu√≠do e salvo.", drawResults);
                });
            } catch (e) {
                // If a transaction fails (e.g., due to already drawn status or error in draw logic)
                console.error("Erro no sorteio (Transaction failed):", e.message);
                // Display error to the user via the modal (re-open it)
                document.getElementById('alertModal').classList.remove('hidden');
                document.getElementById('alertMessage').textContent = `Ocorreu um erro: ${e.message}`;
                document.getElementById('alertConfirmButton').textContent = 'Entendi';
                document.getElementById('alertConfirmButton').onclick = closeAlert;
            }
        };

        // Make functions available globally for use in HTML
        window.saveParticipant = saveParticipant;
        window.confirmAndPerformDraw = confirmAndPerformDraw;
        window.performDraw = performDraw;
        window.closeAlert = closeAlert;


    </script>
</body>
</html>
